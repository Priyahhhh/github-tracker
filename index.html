<!DOCTYPE html>
<html>
<head>
    <title>GitHub Tracker Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f4f4f4;
            margin: 0;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
        #inputSection {
            text-align: center;
            margin-bottom: 20px;
        }
        input, button {
            padding: 8px;
            margin: 5px;
            font-size: 14px;
        }
        #mainLayout {
            display: grid;
            grid-template-columns: 2fr 1fr; /* Left = charts, Right = repo details */
            gap: 20px;
        }
        #userDetails {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            padding: 15px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 10px;
            gap: 20px;
        }
        #userDetails img {
            width: 90px;
            border-radius: 50%;
            border: 2px solid #333;
        }
        #userDetails div {
            text-align: left;
        }
        #charts {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px;
            justify-items: center;
        }
        canvas {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 10px;
            width: 350px !important;
            height: 250px !important;
        }
        #repoDetails {
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 15px;
            max-height: 550px;
            overflow-y: auto;
        }
        #repoDetails h3 {
            margin: 0 0 10px 0;
            color: #333;
        }
        .repoCard {
            border-bottom: 1px solid #ddd;
            padding: 10px 0;
        }
        .repoCard:last-child {
            border-bottom: none;
        }
        .repoCard h4 {
            margin: 0;
            color: #007bff;
        }
        .repoCard p {
            margin: 5px 0;
            font-size: 14px;
            color: #555;
        }
    </style>
</head>
<body>
    <h1>GitHub Tracker Dashboard</h1>

    <div id="inputSection">
        <input type="text" id="username" placeholder="Enter GitHub username">
        <button onclick="fetchData()">Fetch Repos</button>
    </div>

    <div id="userDetails"></div>

    <div id="mainLayout">
        <!-- Charts -->
        <div id="charts">
            <canvas id="repoChart"></canvas>
            <canvas id="langChart"></canvas>
        </div>

        <!-- Repo Details -->
        <div id="repoDetails">
            <h3>Repositories</h3>
            <div id="repoList"></div>
        </div>
    </div>

    <script>
        async function fetchData() {
            const username = document.getElementById('username').value.trim();
            if (!username) return alert('Enter username');

            // --- Fetch user details ---
            const userRes = await fetch(`https://api.github.com/users/${username}`);
            if (!userRes.ok) return alert('User not found');
            const userData = await userRes.json();

            document.getElementById('userDetails').innerHTML = `
                <img src="${userData.avatar_url}" alt="avatar">
                <div>
                    <h3>${userData.name || userData.login}</h3>
                    <p>Followers: ${userData.followers} | Following: ${userData.following}</p>
                    <p>Public Repos: ${userData.public_repos}</p>
                </div>
            `;

            // --- Store repos in backend ---
            await fetch('/fetch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username })
            });

            // --- Get repo data for charts ---
            const repoRes = await fetch(`/chart/${username}`);
            const repos = await repoRes.json();

            // --- Repo Chart ---
            const repoNames = repos.map(r => r.name);
            const stars = repos.map(r => r.stars);
            const forks = repos.map(r => r.forks);

            new Chart(document.getElementById('repoChart'), {
                type: 'bar',
                data: {
                    labels: repoNames,
                    datasets: [
                        { label: 'Stars', data: stars, backgroundColor: 'rgba(75,192,192,0.6)' },
                        { label: 'Forks', data: forks, backgroundColor: 'rgba(153,102,255,0.6)' }
                    ]
                },
                options: {
                    responsive: false,
                    plugins: { legend: { position: 'top' } },
                    scales: { y: { beginAtZero: true } }
                }
            });

            // --- Language Chart (Pie) ---
            const langCount = {};
            await Promise.all(repos.map(async (repo) => {
                try {
                    const langRes = await fetch(`https://api.github.com/repos/${username}/${repo.name}/languages`);
                    const langs = await langRes.json();
                    for (let [lang, bytes] of Object.entries(langs)) {
                        langCount[lang] = (langCount[lang] || 0) + bytes;
                    }
                } catch (err) {
                    console.log('Error fetching languages for repo', repo.name);
                }
            }));

            const languages = Object.keys(langCount);
            const counts = Object.values(langCount);

            new Chart(document.getElementById('langChart'), {
                type: 'pie',
                data: {
                    labels: languages,
                    datasets: [{
                        data: counts,
                        backgroundColor: [
                            'rgba(255,99,132,0.6)',
                            'rgba(54,162,235,0.6)',
                            'rgba(255,206,86,0.6)',
                            'rgba(75,192,192,0.6)',
                            'rgba(153,102,255,0.6)',
                            'rgba(255,159,64,0.6)'
                        ]
                    }]
                },
                options: {
                    responsive: false,
                    plugins: { legend: { position: 'right' } }
                }
            });

            // --- Repository Details Column ---
            const repoList = document.getElementById('repoList');
            repoList.innerHTML = '';
            repos.forEach(repo => {
                repoList.innerHTML += `
                    <div class="repoCard">
                        <h4><a href="${repo.url}" target="_blank">${repo.name}</a></h4>
                        <p>${repo.description || 'No description provided'}</p>
                        <p>‚≠ê Stars: ${repo.stars} | üç¥ Forks: ${repo.forks}</p>
                        <p>Updated: ${new Date(repo.updated).toLocaleDateString()}</p>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>
